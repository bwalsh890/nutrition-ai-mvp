<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition AI - Onboarding</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const OnboardingChat = () => {
            const [messages, setMessages] = useState([]);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [userProfile, setUserProfile] = useState({});
            const [inputValue, setInputValue] = useState('');
            const [isComplete, setIsComplete] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [saveError, setSaveError] = useState(null);
            const [aiPersonality, setAiPersonality] = useState({
                style: 'charismatic',
                intensity: 'high',
                gender: 'neutral',
                ageGroup: 'adult'
            });
            const messagesEndRef = useRef(null);

            // Your strategic questions as context for Dr. Grey
            const STRATEGIC_QUESTIONS = [
                {
                    id: 1,
                    question: "Tell me about how you found this app?",
                    followUp: "What drew you to it?",
                    dataPoint: 'discoveryMethod'
                },
                {
                    id: 2,
                    question: "Why did you want to use it?",
                    followUp: "What are you hoping for?",
                    dataPoint: 'initialMotivation'
                },
                {
                    id: 3,
                    question: "Tell me about what you think needs to change?",
                    followUp: "What's really bothering you?",
                    dataPoint: 'selfAwareness'
                },
                {
                    id: 4,
                    question: "And let's say you did make those changes for the next little while, what do you think is going to happen?",
                    followUp: "How do you think you'd feel?",
                    dataPoint: 'expectations'
                },
                {
                    id: 5,
                    question: "Ok now imagine in your wildest dreams what you would love to happen to your health, your fitness and your appearance?",
                    followUp: "What would that look like?",
                    dataPoint: 'ultimateVision'
                },
                {
                    id: 6,
                    question: "If you have to choose between your health, fitness, strength or appearance which one would you choose?",
                    followUp: "Why is that most important to you?",
                    dataPoint: 'priorityHierarchy'
                },
                {
                    id: 7,
                    question: "What would you like to change most about your appearance?",
                    followUp: "What specifically?",
                    dataPoint: 'appearanceGoals'
                },
                {
                    id: 8,
                    question: "When was the fittest you've ever been?",
                    followUp: "What were you doing then?",
                    dataPoint: 'peakFitnessPeriod'
                },
                {
                    id: 9,
                    question: "What was that like?",
                    followUp: "How did you feel?",
                    dataPoint: 'peakFitnessFeelings'
                },
                {
                    id: 10,
                    question: "Would you ever like to be that fit again?",
                    followUp: "What would that mean to you?",
                    dataPoint: 'desireToReturn'
                },
                {
                    id: 11,
                    question: "Would you ever like to be that skinny, strong, muscular etc again?",
                    followUp: "What specifically?",
                    dataPoint: 'specificBodyGoals'
                },
                {
                    id: 12,
                    question: "And how do you feel now?",
                    followUp: "What's different?",
                    dataPoint: 'currentState'
                },
                {
                    id: 13,
                    question: "And what do you think has contributed towards how you feel now compared to how you felt then?",
                    followUp: "What changed?",
                    dataPoint: 'declineFactors'
                }
            ];

            const NUTRITIONAL_QUESTIONS = [
                {
                    id: 14,
                    question: "Let's get the basics - what's your age, height, and current weight?",
                    dataPoint: 'basicInfo'
                },
                {
                    id: 15,
                    question: "What weight would help you feel the way you want to feel?",
                    dataPoint: 'targetWeight'
                },
                {
                    id: 16,
                    question: "Any health conditions, medications, or allergies I need to know about?",
                    dataPoint: 'healthInfo'
                },
                {
                    id: 17,
                    question: "What's your exercise story? Were you always active growing up, maybe played sports, or has fitness never been your thing?",
                    dataPoint: 'exerciseHistory'
                },
                {
                    id: 18,
                    question: "What kind of activities do you currently do? And be honest - are you hitting the gym regularly, or has it been a while?",
                    dataPoint: 'currentExercise'
                },
                {
                    id: 19,
                    question: "What's your cooking situation? How comfortable are you in the kitchen, and how much time do you realistically have?",
                    dataPoint: 'cookingInfo'
                },
                {
                    id: 20,
                    question: "What's your budget like for food? I need to know what we're working with.",
                    dataPoint: 'budgetInfo'
                }
            ];

            const ALL_QUESTIONS = [...STRATEGIC_QUESTIONS, ...NUTRITIONAL_QUESTIONS];
            const REQUIRED_DATA_POINTS = ALL_QUESTIONS.map(q => q.dataPoint);

            // Progress tracking
            const [conversationProgress, setConversationProgress] = useState(0);

            useEffect(() => {
                checkExistingProfile();
            }, []);

            const checkExistingProfile = async () => {
                try {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    if (!currentUser.id) {
                        // No user logged in, redirect to auth
                        window.location.href = 'auth.html';
                        return;
                    }

                    // Always start the questionnaire for new users
                    if (messages.length === 0) {
                        startConversation();
                    }
                } catch (error) {
                    console.error('Error checking profile:', error);
                    // If there's an error, start onboarding anyway
                    if (messages.length === 0) {
                        startConversation();
                    }
                }
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            const startConversation = () => {
                // Start with introduction and permission
                const introText = "Hi! I'm Dr. Grey, I'm here to help you with nutrition advice and a diet plan. Is it ok if I ask you some questions so I can build you a tailored effective diet?";
                typeMessage(introText, () => {
                    // After intro, wait for user response, then start questions
                    setTimeout(() => {
                        // Set up to ask first question after user responds
                        setCurrentQuestion(0);
                    }, 1000);
                });
            };

            const typeMessage = (text, onComplete) => {
                const messageId = Date.now().toString();
                const aiMessage = {
                    id: messageId,
                    type: 'ai',
                    content: '',
                    timestamp: new Date(),
                    isTyping: true
                };
                setMessages(prev => [...prev, aiMessage]);
                
                let index = 0;
                const typingInterval = setInterval(() => {
                    if (index < text.length) {
                        setMessages(prev => prev.map(msg => 
                            msg.id === messageId 
                                ? { ...msg, content: text.substring(0, index + 1) }
                                : msg
                        ));
                        index++;
                    } else {
                        clearInterval(typingInterval);
                        setMessages(prev => prev.map(msg => 
                            msg.id === messageId 
                                ? { ...msg, isTyping: false }
                                : msg
                        ));
                        if (onComplete) onComplete();
                    }
                }, 15); // 15ms per character for faster typing
            };

            const askNextQuestion = () => {
                console.log('askNextQuestion called, currentQuestion:', currentQuestion, 'total questions:', ALL_QUESTIONS.length);
                
                // Check if we've completed all questions
                if (currentQuestion >= ALL_QUESTIONS.length) {
                    console.log('All questions completed, calling completeOnboarding');
                    completeOnboarding();
                    return;
                }

                // Get the current strategic question
                const currentQ = ALL_QUESTIONS[currentQuestion];
                console.log('Asking question:', currentQ.id, currentQ.question);
                
                // Let Dr. Grey deliver the question naturally
                generateQuestionWithContext(currentQ, () => {
                    // Question is fully typed, ready for user response
                    console.log('Question delivered, waiting for user response');
                });
            };

            const generateQuestionWithContext = async (question, onComplete) => {
                try {
                    const dataPoint = question.dataPoint;
                    const context = `You are Dr. Grey, a charismatic and empathetic nutritionist having a natural conversation.

DATA POINT TO DISCOVER: ${dataPoint}
QUESTION GUIDANCE: "${question.question}"
${question.followUp ? `Follow-up guidance: "${question.followUp}"` : ''}

YOUR TASK:
- Have a natural conversation to discover the ${dataPoint} data point
- Use the question guidance as inspiration, but make it conversational
- Don't ask the question directly - work it into natural conversation
- Be warm, engaging, and genuinely interested
- Build rapport and trust
- Make them feel comfortable opening up

CONVERSATION SO FAR:
${messages.slice(-3).map(msg => 
    `${msg.type === 'user' ? 'User' : 'Dr. Grey'}: ${msg.content}`
).join('\n')}

EXAMPLES OF NATURAL APPROACHES:
- For discoveryMethod: "I'm curious, how did you stumble across this app?"
- For initialMotivation: "What made you think 'I need to do something about this'?"
- For selfAwareness: "What's been bothering you lately when it comes to your health?"
- For ultimateVision: "If you could wake up tomorrow exactly how you want to be, what would that look like?"

Be conversational, not clinical. Make it feel like talking to a knowledgeable friend.`;

                    const aiResponse = await fetch('http://localhost:8000/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: context,
                            conversation_history: messages.slice(-5),
                            health_profile: userProfile
                        })
                    });

                    if (aiResponse.ok) {
                        const data = await aiResponse.json();
                        typeMessage(data.response, onComplete);
                    } else {
                        // Fallback to natural conversation starters
                        const naturalStarters = {
                            'discoveryMethod': "I'm curious, how did you find this app?",
                            'initialMotivation': "What made you decide to try something different?",
                            'selfAwareness': "What's been on your mind lately when it comes to your health?",
                            'expectations': "What do you think would happen if you actually made some changes?",
                            'ultimateVision': "If you could wave a magic wand and wake up tomorrow exactly how you want to be, what would that look like?",
                            'priorityHierarchy': "If you had to pick one thing - feeling strong, looking great, having energy, or being healthy - which matters most to you?",
                            'appearanceGoals': "What would you like to change most about how you look?",
                            'peakFitnessPeriod': "When did you feel your absolute best?",
                            'peakFitnessFeelings': "What was that like for you?",
                            'desireToReturn': "Would you like to get back to that feeling?",
                            'specificBodyGoals': "What specifically are you hoping to achieve?",
                            'currentState': "How are you feeling about yourself right now?",
                            'declineFactors': "What do you think happened between then and now?",
                            'basicInfo': "Let me get some basics - what's your age, height, and current weight?",
                            'targetWeight': "What weight would make you feel amazing?",
                            'healthInfo': "Any health stuff I should know about?",
                            'exerciseHistory': "What's your relationship with exercise been like?",
                            'currentExercise': "What kind of activities do you do now?",
                            'cookingInfo': "What's your cooking situation like?",
                            'budgetInfo': "What's your budget like for food?"
                        };
                        
                        const naturalStarter = naturalStarters[dataPoint] || "Tell me more about that.";
                        typeMessage(naturalStarter, onComplete);
                    }
                } catch (error) {
                    console.error('AI question error:', error);
                    const naturalStarters = {
                        'discoveryMethod': "I'm curious, how did you find this app?",
                        'initialMotivation': "What made you decide to try something different?",
                        'selfAwareness': "What's been on your mind lately when it comes to your health?",
                        'expectations': "What do you think would happen if you actually made some changes?",
                        'ultimateVision': "If you could wave a magic wand and wake up tomorrow exactly how you want to be, what would that look like?",
                        'priorityHierarchy': "If you had to pick one thing - feeling strong, looking great, having energy, or being healthy - which matters most to you?",
                        'appearanceGoals': "What would you like to change most about how you look?",
                        'peakFitnessPeriod': "When did you feel your absolute best?",
                        'peakFitnessFeelings': "What was that like for you?",
                        'desireToReturn': "Would you like to get back to that feeling?",
                        'specificBodyGoals': "What specifically are you hoping to achieve?",
                        'currentState': "How are you feeling about yourself right now?",
                        'declineFactors': "What do you think happened between then and now?",
                        'basicInfo': "Let me get some basics - what's your age, height, and current weight?",
                        'targetWeight': "What weight would make you feel amazing?",
                        'healthInfo': "Any health stuff I should know about?",
                        'exerciseHistory': "What's your relationship with exercise been like?",
                        'currentExercise': "What kind of activities do you do now?",
                        'cookingInfo': "What's your cooking situation like?",
                        'budgetInfo': "What's your budget like for food?"
                    };
                    
                    const naturalStarter = naturalStarters[dataPoint] || "Tell me more about that.";
                    typeMessage(naturalStarter, onComplete);
                }
            };

            const completeOnboarding = async () => {
                try {
                    // Generate AI completion message
                    const context = `You are Dr. Grey, a charismatic nutritionist. The user has just completed your onboarding questionnaire. 

CONTEXT:
- User has answered all questions about their health, fitness, and nutrition goals
- You've been building trust and gathering information throughout the conversation
- This is the completion moment where you need to:
  1. Acknowledge their openness and honesty
  2. Show excitement about their potential
  3. Transition to creating their personalized profile
  4. Maintain the warm, charismatic Dr. Sarah persona

Respond as Dr. Sarah with enthusiasm and warmth, acknowledging their journey and the exciting next steps.`;

                    const aiResponse = await fetch('http://localhost:8000/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: context,
                            conversation_history: messages.slice(-10),
                            health_profile: userProfile
                        })
                    });

                    if (aiResponse.ok) {
                        const data = await aiResponse.json();
                        typeMessage(data.response, () => {
                            setTimeout(() => setIsComplete(true), 2000);
                        });
                    } else {
                        // Fallback
                        const fallbackText = "Wow! 🤩 I'm genuinely impressed by everything you've shared with me. You've been so open and honest, and I can already see the amazing potential here.\n\nLet me create your personalized nutrition profile based on everything you've told me. This is going to be powerful!";
                        typeMessage(fallbackText, () => {
                            setTimeout(() => setIsComplete(true), 2000);
                        });
                    }
                } catch (error) {
                    console.error('AI completion error:', error);
                    const fallbackText = "Wow! 🤩 I'm genuinely impressed by everything you've shared with me. You've been so open and honest, and I can already see the amazing potential here.\n\nLet me create your personalized nutrition profile based on everything you've told me. This is going to be powerful!";
                    typeMessage(fallbackText, () => {
                        setTimeout(() => setIsComplete(true), 2000);
                    });
                }
            };

            const handleSendMessage = () => {
                if (!inputValue.trim()) return;

                const userMessage = {
                    id: Date.now().toString(),
                    type: 'user',
                    content: inputValue,
                    timestamp: new Date()
                };
                setMessages(prev => [...prev, userMessage]);
                processUserResponse(inputValue);
                setInputValue('');
            };

            const processUserResponse = (response) => {
                console.log('processUserResponse called with:', response, 'currentQuestion:', currentQuestion);
                
                // Check if this is the permission response (before questions start)
                if (currentQuestion === 0 && !userProfile.startedQuestions) {
                    console.log('Processing permission response');
                    // User responded to permission request
                    const permissionResponse = response.toLowerCase();
                    if (permissionResponse.includes('yes') || permissionResponse.includes('sure') || permissionResponse.includes('ok') || permissionResponse.includes('yeah')) {
                        // User agreed, start questions
                        console.log('User agreed, starting questions');
                        setUserProfile(prev => ({ ...prev, startedQuestions: true }));
                        setTimeout(() => {
                            askNextQuestion();
                        }, 1000);
                    } else {
                        // User declined or unclear, encourage them
                        setTimeout(() => {
                            typeMessage("I totally get it! The thing is, without understanding your unique situation, I'd just be giving you generic advice that probably won't work for you. These questions help me create something that's actually tailored to YOUR life, YOUR goals, and YOUR challenges. What do you say - ready to get something that actually works?", () => {
                                // Wait for their response
                            });
                        }, 1000);
                    }
                    return;
                }
                
                // Get current question
                const currentQ = ALL_QUESTIONS[currentQuestion];
                console.log('Processing response for question:', currentQ?.id, currentQ?.question);
                
                // Extract data points from the response
                extractDataFromResponse(response);
                
                // Update profile with the specific data point for this question
                if (currentQ && currentQ.dataPoint) {
                    setUserProfile(prev => ({ ...prev, [currentQ.dataPoint]: response }));
                }
                
                // Generate natural AI response
                setTimeout(() => {
                    generateNaturalAIResponse(response, currentQ, () => {
                        console.log('AI response complete, moving to next question');
                        // Move to next question after AI response
                        setTimeout(() => {
                            setCurrentQuestion(prev => {
                                const next = prev + 1;
                                console.log('Setting currentQuestion to:', next);
                                return next;
                            });
                            // Ask the next question after a brief pause
                            setTimeout(() => askNextQuestion(), 1000);
                        }, 1000);
                    });
                }, 1500);
            };

            const extractDataFromResponse = (response) => {
                const text = response.toLowerCase();
                
                // Extract data points based on content analysis
                const dataExtractions = {
                    'discoveryMethod': extractDiscoveryMethod(text),
                    'initialMotivation': extractMotivation(text),
                    'selfAwareness': extractSelfAwareness(text),
                    'currentState': extractCurrentState(text),
                    'ultimateVision': extractVision(text),
                    'appearanceGoals': extractAppearanceGoals(text),
                    'peakFitnessPeriod': extractPeakFitness(text),
                    'declineFactors': extractDeclineFactors(text),
                    'priorityHierarchy': extractPriorities(text),
                    'basicInfo': extractBasicInfo(text),
                    'healthInfo': extractHealthInfo(text),
                    'exerciseHistory': extractExerciseHistory(text)
                };

                // Update profile with extracted data
                Object.entries(dataExtractions).forEach(([key, value]) => {
                    if (value) {
                        setUserProfile(prev => ({ ...prev, [key]: value }));
                    }
                });
            };

            // Data extraction functions
            const extractDiscoveryMethod = (text) => {
                if (text.includes('instagram') || text.includes('gram')) return 'social_media';
                if (text.includes('google') || text.includes('search')) return 'search';
                if (text.includes('friend') || text.includes('recommend')) return 'referral';
                return 'other';
            };

            const extractMotivation = (text) => {
                if (text.includes('weight') || text.includes('lose')) return 'weight_loss';
                if (text.includes('energy') || text.includes('tired')) return 'energy';
                if (text.includes('health') || text.includes('healthy')) return 'health';
                if (text.includes('fit') || text.includes('strong')) return 'fitness';
                return 'general_wellness';
            };

            const extractSelfAwareness = (text) => {
                if (text.includes('know') || text.includes('realize') || text.includes('think')) return 'high';
                if (text.includes('not sure') || text.includes('confused')) return 'low';
                return 'medium';
            };

            const extractCurrentState = (text) => {
                if (text.includes('tired') || text.includes('exhausted')) return 'low_energy';
                if (text.includes('frustrated') || text.includes('stressed')) return 'stressed';
                if (text.includes('okay') || text.includes('fine')) return 'neutral';
                return 'mixed';
            };

            const extractVision = (text) => {
                if (text.includes('confident') || text.includes('proud')) return 'confidence';
                if (text.includes('energy') || text.includes('vitality')) return 'energy';
                if (text.includes('strong') || text.includes('muscle')) return 'strength';
                return 'general_wellness';
            };

            const extractAppearanceGoals = (text) => {
                if (text.includes('skinny') || text.includes('thin')) return 'weight_loss';
                if (text.includes('muscle') || text.includes('toned')) return 'muscle_gain';
                if (text.includes('fit') || text.includes('athletic')) return 'fitness';
                return 'general_improvement';
            };

            const extractPeakFitness = (text) => {
                if (text.includes('college') || text.includes('university')) return 'college';
                if (text.includes('high school') || text.includes('teen')) return 'high_school';
                if (text.includes('recent') || text.includes('last year')) return 'recent';
                return 'past_period';
            };

            const extractDeclineFactors = (text) => {
                if (text.includes('busy') || text.includes('work')) return 'work_life';
                if (text.includes('kids') || text.includes('family')) return 'family';
                if (text.includes('injury') || text.includes('hurt')) return 'injury';
                if (text.includes('motivation') || text.includes('lazy')) return 'motivation';
                return 'life_changes';
            };

            const extractPriorities = (text) => {
                if (text.includes('health') || text.includes('healthy')) return 'health';
                if (text.includes('look') || text.includes('appearance')) return 'appearance';
                if (text.includes('strong') || text.includes('fitness')) return 'fitness';
                if (text.includes('energy') || text.includes('vitality')) return 'energy';
                return 'general';
            };

            const extractBasicInfo = (text) => {
                const ageMatch = text.match(/(\d+)\s*(?:years?|yrs?)/);
                const heightMatch = text.match(/(\d+)\s*(?:cm|centimeters?|inches?|ft|feet)/);
                const weightMatch = text.match(/(\d+)\s*(?:kg|kilos?|pounds?|lbs?)/);
                
                return {
                    age: ageMatch ? parseInt(ageMatch[1]) : null,
                    height: heightMatch ? parseInt(heightMatch[1]) : null,
                    weight: weightMatch ? parseInt(weightMatch[1]) : null
                };
            };

            const extractHealthInfo = (text) => {
                if (text.includes('allergy') || text.includes('allergic')) return 'allergies';
                if (text.includes('medication') || text.includes('meds')) return 'medications';
                if (text.includes('condition') || text.includes('diabetes') || text.includes('blood pressure')) return 'conditions';
                return 'none';
            };

            const extractExerciseHistory = (text) => {
                if (text.includes('always') || text.includes('grew up')) return 'always_active';
                if (text.includes('never') || text.includes('hate')) return 'never_active';
                if (text.includes('used to') || text.includes('before')) return 'past_active';
                return 'mixed';
            };

            const generateNaturalAIResponse = async (response, currentQ, onComplete) => {
                try {
                    // First validate the response
                    const isValidResponse = validateResponse(response, currentQ);
                    
                    if (!isValidResponse) {
                        // Response is not valid, ask for clarification
                        const clarificationResponses = [
                            "I'm not sure I understand that. Can you tell me more about what you mean?",
                            "That's interesting, but I need to understand better. Can you explain that a bit more?",
                            "I want to make sure I get this right. Can you help me understand what you're thinking?",
                            "I'm not quite following. Can you give me a bit more detail?",
                            "I want to understand you better. Can you tell me more about that?"
                        ];
                        const randomResponse = clarificationResponses[Math.floor(Math.random() * clarificationResponses.length)];
                        typeMessage(randomResponse, onComplete);
                        return;
                    }

                    const context = `You are Dr. Grey, a charismatic and empathetic nutritionist having a natural conversation.

CURRENT QUESTION: "${currentQ ? currentQ.question : 'general conversation'}"
USER RESPONSE: "${response}"

YOUR TASK:
- Acknowledge their response specifically 
- Show genuine interest in what they shared
- Be warm and encouraging
- Keep it brief (1-2 sentences)
- Don't ask another question - just acknowledge and move on

EXAMPLES OF GOOD RESPONSES:
- "That's really helpful to know. I can tell this matters to you."
- "I appreciate you sharing that with me. That tells me a lot about your situation."
- "That's exactly what I needed to hear. Thank you for being so honest."
- "I can feel how important this is to you. That's going to help me help you better."

Be specific to what they said, not generic.`;

                    const aiResponse = await fetch('http://localhost:8000/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: context,
                            conversation_history: messages.slice(-3),
                            health_profile: userProfile
                        })
                    });

                    if (aiResponse.ok) {
                        const data = await aiResponse.json();
                        typeMessage(data.response, onComplete);
                    } else {
                        // Fallback to specific acknowledgment
                        const fallbackResponse = getSpecificAcknowledgment(response, currentQ);
                        typeMessage(fallbackResponse, onComplete);
                    }
                } catch (error) {
                    console.error('AI response error:', error);
                    const fallbackResponse = getSpecificAcknowledgment(response, currentQ);
                    typeMessage(fallbackResponse, onComplete);
                }
            };

            const validateResponse = (response, currentQ) => {
                const text = response.toLowerCase().trim();
                
                // Check for obviously invalid responses
                if (text.length < 2) return false;
                if (text === 'tonga' || text === 'test' || text === 'asdf' || text === 'qwerty') return false;
                if (text.match(/^[0-9]+$/)) return false; // Just numbers
                if (text.match(/^[a-z]{1,3}$/)) return false; // Very short random text
                
                // Be more lenient - if it's a reasonable length and not obviously spam, accept it
                if (text.length >= 3) return true;
                
                return false;
            };

            const getSpecificAcknowledgment = (response, currentQ) => {
                const text = response.toLowerCase();
                
                if (text.includes('instagram') || text.includes('social') || text.includes('browsing')) {
                    return "Ah, social media! That's how a lot of people discover us. What caught your attention?";
                }
                if (text.includes('google') || text.includes('search')) {
                    return "Google search - perfect! What were you looking for when you found us?";
                }
                if (text.includes('friend') || text.includes('recommend')) {
                    return "Word of mouth - that's the best way to find something good! Who told you about us?";
                }
                if (text.includes('weight') || text.includes('lose')) {
                    return "I can tell weight loss is on your mind. That's completely understandable.";
                }
                if (text.includes('energy') || text.includes('tired')) {
                    return "Energy issues - I hear that a lot. It's one of the most common things people want to fix.";
                }
                if (text.includes('health') || text.includes('healthy')) {
                    return "Health is such an important foundation. I'm glad you're thinking about it.";
                }
                
                return "Thank you for sharing that with me. That's really helpful to know.";
            };

            const generateAIResponse = async (response, currentQ, onComplete) => {
                try {
                    // Build context for the AI
                    const context = buildContextForAI(response, currentQ);
                    
                    console.log('Sending AI request:', context); // Debug log
                    
                    // Call the AI service
                    const aiResponse = await fetch('http://localhost:8000/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: context,
                            conversation_history: messages.slice(-5), // Last 5 messages for context
                            health_profile: userProfile
                        })
                    });

                    console.log('AI response status:', aiResponse.status); // Debug log

                    if (aiResponse.ok) {
                        const data = await aiResponse.json();
                        console.log('AI response data:', data); // Debug log
                        typeMessage(data.response, onComplete);
                    } else {
                        console.log('AI response failed, using fallback');
                        // Fallback to pre-made response if AI fails
                        const fallbackResponse = getDeepAcknowledgment(response, currentQ.dataPoint);
                        typeMessage(fallbackResponse, onComplete);
                    }
                } catch (error) {
                    console.error('AI response error:', error);
                    // Fallback to pre-made response
                    const fallbackResponse = getDeepAcknowledgment(response, currentQ.dataPoint);
                    typeMessage(fallbackResponse, onComplete);
                }
            };

            const buildContextForAI = (response, currentQ) => {
                const sentiment = analyzeSentiment(response);
                const { positive, negative, urgent, committed, overall } = sentiment;
                
                // Get conversation context
                const recentMessages = messages.slice(-3).map(msg => 
                    `${msg.type === 'user' ? 'User' : 'Dr. Sarah'}: ${msg.content}`
                ).join('\n');
                
                return `You are Dr. Sarah, a charismatic and empathetic nutritionist/psychologist conducting an onboarding questionnaire.

RECENT CONVERSATION:
${recentMessages}

CURRENT MOMENT:
- Question asked: "${currentQ.question}"
- User just responded: "${response}"
- Sentiment: ${overall > 0 ? 'positive' : overall < 0 ? 'negative' : 'neutral'} (${overall} score)
- Urgency: ${urgent > 0 ? 'high' : 'normal'}
- Commitment: ${committed > 0 ? 'high' : 'normal'}

YOUR RESPONSE:
Respond as Dr. Sarah with a unique, personalized acknowledgment that:
1. References something specific from their response
2. Shows you're actively listening
3. Validates their feelings
4. Provides a brief psychological insight
5. Is warm and conversational

IMPORTANT: Make this response unique and specific to what they just said. Don't repeat previous responses.`;
            };

            const getDeepAcknowledgment = (response, dataPoint) => {
                const sentiment = analyzeSentiment(response);
                return generateTrustBuildingResponse(response, sentiment, dataPoint);
            };

            const generateTrustBuildingResponse = (response, sentiment, dataPoint) => {
                const { positive, negative, urgent, committed, overall } = sentiment;
                
                // Extract key phrases for active listening
                const keyPhrases = extractKeyPhrases(response);
                
                // Build trust through active listening and validation
                let trustResponse = "";
                
                // Active Listening - reflect back what they said
                if (keyPhrases.length > 0) {
                    trustResponse += `I hear you saying "${keyPhrases[0]}"... `;
                }
                
                // Validation based on sentiment
                if (overall > 2) {
                    trustResponse += "I can feel the excitement and determination in your words. That energy is going to be your greatest asset in this journey.";
                } else if (overall < -2) {
                    trustResponse += "What you're feeling is completely valid and understandable. I want you to know that you're not alone in this struggle.";
                } else if (urgent > 0) {
                    trustResponse += "I can sense the urgency in what you're sharing. That urgency tells me this really matters to you, and that's exactly what we need.";
                } else if (committed > 0) {
                    trustResponse += "I can tell you're serious about this. That level of commitment is what creates real, lasting change.";
                } else {
                    trustResponse += "Thank you for being so honest with me. I can tell you're really thinking about this.";
                }
                
                // Add psychological insights based on data point
                trustResponse += " " + getPsychologicalInsight(dataPoint, response, sentiment);
                
                return trustResponse;
            };

            const extractKeyPhrases = (response) => {
                // Simple key phrase extraction - look for emotional words and important concepts
                const words = response.toLowerCase().split(' ');
                const keyPhrases = [];
                
                // Look for emotional indicators
                const emotionalWords = ['feel', 'think', 'want', 'need', 'tired', 'excited', 'frustrated', 'hopeful', 'scared', 'ready'];
                emotionalWords.forEach(word => {
                    if (words.includes(word)) {
                        const index = words.indexOf(word);
                        if (index > 0 && index < words.length - 1) {
                            keyPhrases.push(`${words[index-1]} ${word} ${words[index+1]}`);
                        }
                    }
                });
                
                return keyPhrases.slice(0, 2); // Return top 2 phrases
            };

            const getPsychologicalInsight = (dataPoint, response, sentiment) => {
                const insights = {
                    'discoveryMethod': "The fact that you found this app tells me you're actively seeking solutions, and that's the first step to real change.",
                    'initialMotivation': "I'm noticing something important here - you're not just going through the motions. You have a real reason for being here.",
                    'selfAwareness': "This level of self-awareness is actually quite rare. Most people aren't this honest about what needs to change.",
                    'expectations': "I love that you're thinking about the outcome. That forward-thinking mindset is going to serve you well.",
                    'ultimateVision': "That vision you just described? That's not just a dream - that's your future self calling to you.",
                    'priorityHierarchy': "This tells me so much about what really matters to you. When we know our priorities, everything else becomes clearer.",
                    'appearanceGoals': "I can tell this isn't just about looks for you - there's something deeper driving this desire for change.",
                    'peakFitnessPeriod': "That period you described? That's proof that you CAN do this. Your body remembers how to feel that way.",
                    'peakFitnessFeelings': "Those feelings you had then? They're not gone forever - they're just waiting for you to come back to them.",
                    'desireToReturn': "That desire to get back to that place? That's your authentic self calling you home.",
                    'specificBodyGoals': "I can feel the specificity in what you want. That clarity is going to be your roadmap to success.",
                    'currentState': "I hear the contrast between where you are now and where you want to be. That gap? That's where the magic happens.",
                    'declineFactors': "You've just identified the exact obstacles we need to work around. Knowledge is power, and now we know what we're dealing with."
                };
                
                return insights[dataPoint] || "I'm really getting to know you through this conversation, and I can already see the potential here.";
            };

            const generateSentimentResponse = (sentiment, dataPoint) => {
                const { positive, negative, urgent, committed, overall } = sentiment;
                
                // High positive sentiment
                if (overall > 2) {
                    return "I love that energy! 🔥 I can feel your excitement and determination.";
                }
                
                // High negative sentiment
                if (overall < -2) {
                    return "I hear you. And I want you to know - what you're feeling is completely valid. We're going to work through this together.";
                }
                
                // High urgency
                if (urgent > 0) {
                    return "I can feel how important this is to you. That urgency is going to be your superpower.";
                }
                
                // High commitment
                if (committed > 0) {
                    return "That's exactly the kind of commitment that creates real change. I'm excited to work with you.";
                }
                
                // Neutral/balanced sentiment
                return "Thank you for sharing that with me. I can tell you're being really honest, and that's exactly what I need.";
            };

            const generatePersonalityResponse = (dataPoint, type) => {
                const { style, intensity, gender, ageGroup } = aiPersonality;
                
                // Base responses by data point
                const baseResponses = {
                    'mainMotivation': {
                        charismatic: [
                            "YES! 🔥 That's the fire I was looking for. I can already see the transformation happening.",
                            "Boom. That's it. That's the WHY that's going to carry you through everything.",
                            "Perfect. Now I know exactly who I'm working with. You're not playing games."
                        ],
                        empathetic: [
                            "I hear you. And I want you to know - what you're feeling is completely valid.",
                            "That's exactly why you're here. Because you're ready for something different.",
                            "I can feel the weight of that. And I promise you - we're going to lift it together."
                        ],
                        supportive: [
                            "That's beautiful. I can tell this really matters to you.",
                            "Thank you for sharing that with me. That takes courage.",
                            "I understand. And I'm here to help you make this happen."
                        ]
                    },
                    'currentEnergyLevel': {
                        charismatic: [
                            "I see you. And I promise you - we're about to change that completely.",
                            "That's exactly why you're here. Because you're done feeling like this.",
                            "Got it. This is where the magic happens. We're flipping this script."
                        ],
                        empathetic: [
                            "I can feel how tired you are. And I want you to know - this isn't your fault.",
                            "That's exactly why you're here. Because you're ready to feel alive again.",
                            "I hear the exhaustion in that. And I promise you - we're going to change this."
                        ],
                        supportive: [
                            "I understand. Energy is everything, and we're going to get yours back.",
                            "That's why you're here. Because you're ready to feel better.",
                            "I hear you. And I'm going to help you get your energy back."
                        ]
                    }
                };

                // Gender-specific adaptations
                const genderAdaptations = {
                    'male': {
                        high_intensity: ['bro', 'man', 'dude'],
                        moderate_intensity: ['friend', 'buddy']
                    },
                    'female': {
                        high_intensity: ['girl', 'queen', 'beautiful'],
                        moderate_intensity: ['love', 'sweetheart']
                    }
                };

                // Age-specific adaptations
                const ageAdaptations = {
                    'young': {
                        slang: ['lit', 'fire', 'vibes', 'slay'],
                        intensity: 'very_high'
                    },
                    'mature': {
                        respectful: ['I appreciate', 'I understand', 'I respect'],
                        intensity: 'moderate'
                    }
                };

                // Get base response
                const responses = baseResponses[dataPoint]?.[style] || baseResponses[dataPoint]?.['charismatic'] || ["I hear you."];
                let selectedResponse = responses[Math.floor(Math.random() * responses.length)];

                // Apply gender adaptations
                if (gender !== 'neutral' && genderAdaptations[gender]) {
                    const adaptations = genderAdaptations[gender][intensity === 'very_high' ? 'high_intensity' : 'moderate_intensity'];
                    if (adaptations && Math.random() > 0.5) {
                        selectedResponse = selectedResponse.replace('you', adaptations[0]);
                    }
                }

                // Apply age adaptations
                if (ageGroup === 'young' && Math.random() > 0.7) {
                    const slang = ageAdaptations.young.slang;
                    selectedResponse += ` ${slang[Math.floor(Math.random() * slang.length)]}!`;
                }

                return selectedResponse;
            };

            const analyzeSentiment = (response) => {
                const text = response.toLowerCase();
                
                // Positive sentiment indicators
                const positiveWords = ['excited', 'ready', 'confident', 'motivated', 'determined', 'strong', 'amazing', 'great', 'wonderful', 'fantastic', 'love', 'enjoy', 'happy', 'proud', 'successful', 'achieved', 'accomplished', 'thriving', 'energized', 'powerful'];
                
                // Negative sentiment indicators  
                const negativeWords = ['tired', 'exhausted', 'frustrated', 'stressed', 'overwhelmed', 'struggling', 'difficult', 'hard', 'challenging', 'depressed', 'sad', 'angry', 'disappointed', 'failing', 'stuck', 'hopeless', 'defeated', 'weak', 'sick', 'pain'];
                
                // Urgency indicators
                const urgentWords = ['urgent', 'immediately', 'now', 'asap', 'critical', 'important', 'desperate', 'need', 'must', 'have to', 'can\'t wait', 'finally'];
                
                // Commitment indicators
                const committedWords = ['committed', 'dedicated', 'serious', 'focused', 'determined', 'all in', 'ready', 'willing', 'prepared', 'invested', 'devoted'];
                
                let positiveCount = 0;
                let negativeCount = 0;
                let urgentCount = 0;
                let committedCount = 0;
                
                positiveWords.forEach(word => {
                    if (text.includes(word)) positiveCount++;
                });
                
                negativeWords.forEach(word => {
                    if (text.includes(word)) negativeCount++;
                });
                
                urgentWords.forEach(word => {
                    if (text.includes(word)) urgentCount++;
                });
                
                committedWords.forEach(word => {
                    if (text.includes(word)) committedCount++;
                });
                
                return {
                    positive: positiveCount,
                    negative: negativeCount,
                    urgent: urgentCount,
                    committed: committedCount,
                    overall: positiveCount - negativeCount
                };
            };

            const updateUserProfile = (dataPoint, value) => {
                setUserProfile(prev => {
                    const newProfile = {
                        ...prev,
                        [dataPoint]: value
                    };
                    
                    // Analyze response and adapt AI personality
                    adaptAIPersonality(dataPoint, value, newProfile);
                    
                    return newProfile;
                });
            };

            const adaptAIPersonality = (dataPoint, value, profile) => {
                let newPersonality = { ...aiPersonality };

                // Analyze age from responses
                if (dataPoint === 'age' && value) {
                    const age = parseInt(value);
                    if (age < 25) {
                        newPersonality.ageGroup = 'young';
                        newPersonality.intensity = 'very_high';
                    } else if (age > 50) {
                        newPersonality.ageGroup = 'mature';
                        newPersonality.intensity = 'moderate';
                    } else {
                        newPersonality.ageGroup = 'adult';
                        newPersonality.intensity = 'high';
                    }
                }

                // Analyze gender from responses
                if (dataPoint === 'gender' && value) {
                    newPersonality.gender = value.toLowerCase();
                }

                // Analyze motivation level
                if (dataPoint === 'mainMotivation' && value) {
                    const motivation = value.toLowerCase();
                    if (motivation.includes('energy') || motivation.includes('tired') || motivation.includes('exhausted')) {
                        newPersonality.style = 'empathetic';
                        newPersonality.intensity = 'moderate';
                    } else if (motivation.includes('confident') || motivation.includes('ready') || motivation.includes('excited')) {
                        newPersonality.style = 'charismatic';
                        newPersonality.intensity = 'very_high';
                    }
                }

                // Analyze commitment level
                if (dataPoint === 'commitmentLevel' && typeof value === 'number') {
                    if (value >= 8) {
                        newPersonality.intensity = 'very_high';
                        newPersonality.style = 'charismatic';
                    } else if (value <= 4) {
                        newPersonality.intensity = 'moderate';
                        newPersonality.style = 'supportive';
                    }
                }

                setAiPersonality(newPersonality);
            };

            const askFollowUp = (followUp) => {
                typeMessage(followUp, () => {
                    // Follow-up is fully typed, ready for user response
                });
            };

            const moveToNextQuestion = () => {
                setCurrentQuestion(prev => prev + 1);
                setTimeout(() => askNextQuestion(), 1000);
            };

            const generateMissionStatement = () => {
                const { mainMotivation, deepWhy, sixMonthVision } = userProfile;
                return `I want ${mainMotivation} so I can ${sixMonthVision} because ${deepWhy}`;
            };

            const saveProfileToDatabase = async () => {
                setIsSaving(true);
                setSaveError(null);
                
                try {
                    const username = `user_${Date.now()}`;
                    const email = `${username}@nutrition-ai.local`;
                    
                    const userData = {
                        username: username,
                        email: email,
                        full_name: userProfile.fullName || 'Nutrition AI User',
                        password: 'temp_password_123'
                    };

                    const userResponse = await fetch('http://localhost:8000/users/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData)
                    });

                    if (!userResponse.ok) {
                        throw new Error('Failed to create user account');
                    }

                    const user = await userResponse.json();

                    const healthProfile = {
                        age: userProfile.age || 30,
                        gender: userProfile.gender || 'prefer_not_to_say',
                        height_cm: userProfile.height || 170,
                        weight_kg: userProfile.currentWeight || 70,
                        activity_level: mapExerciseToActivityLevel(userProfile.exerciseFrequency, userProfile.exerciseIntensity),
                        health_conditions: extractHealthConditions(userProfile),
                        fitness_goals: extractFitnessGoals(userProfile),
                        dietary_restrictions: extractDietaryRestrictions(userProfile),
                        allergies: userProfile.noGoFoods ? [userProfile.noGoFoods] : [],
                        medications: [],
                        cooking_skill: 'intermediate',
                        time_available: '30_minutes',
                        budget: '400_600',
                        additional_notes: generateMissionStatement()
                    };

                    const healthResponse = await fetch(`http://localhost:8000/users/${user.id}/health-profile`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(healthProfile)
                    });

                    if (!healthResponse.ok) {
                        throw new Error('Failed to create health profile');
                    }

                    window.location.href = 'dashboard.html';

                } catch (error) {
                    console.error('Error saving profile:', error);
                    setSaveError(error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            const mapExerciseToActivityLevel = (frequency, intensity) => {
                if (frequency >= 6) return 'very_active';
                if (frequency >= 4) return 'moderately_active';
                if (frequency >= 2) return 'lightly_active';
                return 'sedentary';
            };

            const extractHealthConditions = (profile) => {
                const conditions = [];
                if (profile.foodRelationship && profile.foodRelationship.includes('battle')) {
                    conditions.push('digestive_issues');
                }
                return conditions;
            };

            const extractFitnessGoals = (profile) => {
                const goals = [];
                if (profile.targetWeight && profile.currentWeight && profile.targetWeight < profile.currentWeight) {
                    goals.push('weight_loss');
                } else if (profile.targetWeight && profile.currentWeight && profile.targetWeight > profile.currentWeight) {
                    goals.push('muscle_gain');
                }
                if (profile.desiredEnergyLevel > profile.currentEnergyLevel) {
                    goals.push('increase_energy');
                }
                return goals;
            };

            const extractDietaryRestrictions = (profile) => {
                const restrictions = [];
                if (profile.dietaryStyle) {
                    restrictions.push(profile.dietaryStyle.toLowerCase().replace(' ', '_'));
                }
                return restrictions;
            };

            if (isComplete) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full">
                            <div className="text-center">
                                <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                                <h2 className="text-2xl font-bold text-gray-900 mb-4">Amazing! 🎉</h2>
                                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mb-6">
                                    <p className="text-lg text-gray-700 italic">"{generateMissionStatement()}"</p>
                                </div>
                                <p className="text-gray-600 mb-8">I've got everything I need to create your personalized nutrition plan. This is going to be powerful!</p>
                                
                                {saveError && (
                                    <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                                        <p className="text-red-600">Error: {saveError}</p>
                                    </div>
                                )}
                                
                                <button 
                                    onClick={saveProfileToDatabase}
                                    disabled={isSaving}
                                    className="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isSaving ? 'Creating Your Profile...' : 'Let\'s Go! 🚀'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col">
                    <div className="bg-white shadow-sm border-b p-4">
                        <div className="max-w-4xl mx-auto">
                            <h1 className="text-xl font-semibold text-gray-900">Discover Your Nutrition Path</h1>
                            <div className="mt-2">
                                <div className="bg-gray-200 rounded-full h-2">
                                    <div 
                                        className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                        style={{ width: `${(Object.keys(userProfile).length / REQUIRED_DATA_POINTS.length) * 100}%` }}
                                    />
                                </div>
                                <p className="text-sm text-gray-600 mt-1">
                                    Question {currentQuestion + 1} of {ALL_QUESTIONS.length} - Let's have a conversation about your health and fitness goals
                                </p>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-hidden">
                        <div className="h-full overflow-y-auto p-4">
                            <div className="max-w-4xl mx-auto space-y-4">
                                {messages.map((message) => (
                                    <div
                                        key={message.id}
                                        className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}
                                    >
                                        <div
                                            className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                                                message.type === 'user'
                                                    ? 'bg-blue-600 text-white'
                                                    : 'bg-white text-gray-900 shadow-sm'
                                            }`}
                                        >
                                            <p className="text-sm">
                                                {message.content}
                                                {message.isTyping && <span className="animate-pulse">|</span>}
                                            </p>
                                            <p className="text-xs opacity-70 mt-1">
                                                {message.timestamp.toLocaleTimeString()}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                                <div ref={messagesEndRef} />
                            </div>
                        </div>
                    </div>

                    <div className="bg-white border-t p-4">
                        <div className="max-w-4xl mx-auto">
                            <div className="flex space-x-2">
                                <input
                                    type="text"
                                    value={inputValue}
                                    onChange={(e) => setInputValue(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                    placeholder="Type your response..."
                                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    disabled={isComplete}
                                />
                                <button
                                    onClick={handleSendMessage}
                                    disabled={!inputValue.trim() || isComplete}
                                    className="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            return <OnboardingChat />;
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
